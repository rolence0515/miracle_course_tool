{% extends "layout.html" %} {% block title %}奇蹟課程學員練習記錄工具{% endblock %} {% block head %}
<style type="text/css">
    .crop-text-2 {
        /*兩行點點點*/
        -webkit-line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-box-orient: vertical;
    }

    h1,.prm-text {
        color: #303133
    }

    .reg-text {
        color: #606266
    }

</style>
{% endblock %}
 {% block content %}
<h1 class="mb-3">學員練習記錄工具</h1>
<el-row class="mb-3">
    <el-col :span="24">
        <md-progress-bar md-mode="determinate" :md-value="progs"></md-progress-bar>
    </el-col>
</el-row>
<el-row class="mb-3" type="flex" justify="end">
    <el-col :xs="8" :sm="6" :md="4" :lg="3" :xl="3">
        <el-select style="float:right" v-model="local_data.ftr" @change="onftr_change" placeholder="過濾">
            <el-option label="顯示全部" value="顯示全部">
            </el-option>
            <el-option label="顯示未完成" value="顯示未完成">
            </el-option>
            <el-option label="顯示已完成" value="顯示已完成">
            </el-option>
        </el-select>

    </el-col>
</el-row>
<el-row :gutter="5">
    <el-col v-for="b in get_display_items()" class="mb-1" :xs="24" :sm="6" :md="6" :lg="6" :xl="4">
        <div class="grid-content bg-purple">
            <v-practice :chk="local_data.chks.includes(b['idx'])" 
            @onmp3click="onmp3click(b['d']['ttl'], b['d']['txt'], b['idx'])"
            @oninfoclick="oninfoclick(b['d']['ttl'], b['d']['txt'], b['idx'])" :id="b['idx']" :title="b['d']['ttl']"
            @onchangecheck="onchangecheck">
            </v-practice>
        </div>
    </el-col>
</el-row>
<!--  -->
<md-dialog :md-active.sync="showDialog" @md-opened="on_showDialog" style="width: 90%;">
    <md-dialog-title class="prm-text">
        [[dialog_ttl]]
    </md-dialog-title>
    <md-dialog-content>
        <div id="copy" class="reg-text" v-html="dialog_txt" ></div>
    </md-dialog-content>
    <md-dialog-actions>
        <md-button  class="md-primary clipboard" data-clipboard-target="#copy">複製</md-button>
        <md-button class="md-primary" @click="showDialog = false">關閉</md-button>
    </md-dialog-actions>
</md-dialog>

<md-dialog :md-active.sync="show_mp3_Dialog" @md-opened="on_showmp3player" style="width: 90%;">
    <md-dialog-title class="prm-text">
        [[dialog_ttl]]
    </md-dialog-title>
    <md-dialog-content>
        <iframe 
            frameborder="0"  
            style="width:100%;height: 200px"
            :src="dialog_mp3">    
        </iframe>
    </md-dialog-content>
    <md-dialog-actions>
        <md-button class="md-primary" @click="show_mp3_Dialog = false">關閉</md-button>
    </md-dialog-actions>
</md-dialog>

{% endblock %} 

{% block js %}
<script src="/static/js/v-practice.js?20190404"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/audiojs/1.0.1/audio.min.js"></script>
<script src="/static/audiojs/audio.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/vue-aplayer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.1.1/howler.min.js"></script> -->

<script>
$(function () {
    new ClipboardJS('.clipboard');
    
});
</script>
<script>
    Vue.component('aplayer', VueAPlayer)

    var obj;
    obj = new Vue({
        delimiters: ['[[', ']]'],
        el: '#layout',
        mixins: [layoutVue],//layout 資料
        breadpath: [{ key: '首頁', path: '' }],//面包序
        data: {
            show_mp3_Dialog :false, //是否顯示mp3對話框
            showDialog: false, //顯示對話框
            dialog_mp3:"", //對框框mp3
            dialog_ttl: "", //對話框標題
            dialog_txt: "", //對話框內文
            books: {{books | safe }}, //練習手冊內文
            mp3lst : {{mp3lst | safe}}, //音頻檔資料
            local_data:{ //儲存在瀏覽器的資料
                chks :[0, 1, 2, 3], //使用者勾選的(完成)
                ftr :"顯示全部", //過濾條件
            },
            msg: "test",//訊息
            progs:0,//目前進度
            user_id:'1'//使用者編號
        },
        methods: {
            get_display_items() {
                //跟據過濾條件顯示項目
                app = this;
                if (this.local_data.ftr == "顯示全部") {
                    return this.books;
                } else if (this.local_data.ftr == "顯示未完成") {
                    return _.filter(this.books, function (b) {
                        return !app.local_data.chks.includes(b["idx"])
                    });
                } else {
                    return _.filter(this.books, function (b) {
                        return app.local_data.chks.includes(b["idx"])
                    });
                }
            },
            onftr_change(v){
                this.save_localStorage();
            },
            ischk(idx) {
                //判斷是否已完成
                return
            },
            oninfoclick(ttl, txt, idx) {
                //點擊更多資訊
                // this.dialog_mp3 = this.mp3lst[idx]['data']['link'];
                this.dialog_ttl = ttl;
                this.dialog_txt = txt;
                this.dialog_idx = idx;
                this.showDialog = true
            },
            onmp3click(ttl, txt, idx) {
                //點擊更多資訊
                this.dialog_mp3 = this.mp3lst[idx]['data']['link'];
                this.dialog_ttl = ttl;
                this.dialog_txt = txt;
                this.dialog_idx = idx;
                // var sound = new Howl(
                //     {src: [this.dialog_mp3]}
                // );
                // sound.play();
                this.show_mp3_Dialog = true
            },
            onchangecheck(idx, chk) {
                //使用者勾選某課,idx課索引，chk是否勾選
                if (chk) {
                    this.local_data.chks.push(idx);
                    post_to_mongo(op="push", chk_idx=idx, id=userid)
                } else {
                    this.local_data.chks.pop(idx)
                    post_to_mongo(op="pull", chk_idx=idx, id=userid)
                }
                this.update_progress();
                this.save_localStorage();
            },
            update_progress(){
                this.progs = (this.local_data.chks.length / 365) * 100
            },
            on_showDialog() {
              
            },
            on_showmp3player(){

            },
            on_copy_txturl_to_clip(){

            },
            save_localStorage(){
                //save to local straoge
                localStorage.miraclecoursetool = JSON.stringify(this.local_data)
            },
            load_localStroage(){
                //載入資料
                if (localStorage.miraclecoursetool) {
                    data = JSON.parse(localStorage.miraclecoursetool)
                    this.local_data = data
                }   
            },
            post_to_mongo(op, chk_idx, id){
                //儲存資料庫
                data = {
                   'op':op, //操作，pull, push
                   'idx':chk_idx, //課號
                   'id':this.user_id, //使用者號
                }
                $.post("api/update", data, function(data) {
                   console.log('ok')
                });
            }
        },
        watch: {

        },
        mounted:function () {
            this.load_localStroage();
            this.update_progress();
            this.post_to_mongo();
        }

});

</script> 
{% endblock %}